{% load static %}
<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<title>ورود / ثبت‌نام</title>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<style>
body {
    font-family: sans-serif;
    background: #f5f5f5;
    direction: rtl;
    text-align: center;
}

.container {
    width: 350px;
    margin: 50px auto;
    background: white;
    padding: 25px;
    border-radius: 12px;
    box-shadow: 0 0 15px rgba(0,0,0,0.1);
}

.step { display: none; animation: fade 0.4s ease; }
.step.active { display: block; }

@keyframes fade {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

input {
    width: 90%;
    padding: 10px;
    margin: 10px 0;
    border-radius: 8px;
    border: 1px solid #ccc;
}

button {
    padding: 10px 15px;
    background: #2196f3;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
}

button:hover { background: #1976d2; }

.error {
    color: red;
    margin-top: 10px;
    min-height: 20px;
}
</style>
</head>
<body>

<div class="container">
<h2>ورود / ثبت‌نام</h2>

<div id="steps">

    <!-- STEP 1: PHONE -->
    <div class="step step-phone active">
        <label>شماره موبایل</label>
        <input type="text" id="phone_number">
        <button id="send_otp_btn">ارسال کد</button>
        <p class="error" id="phone_error"></p>
    </div>

    <!-- STEP 2: OTP -->
    <div class="step step-otp">
        <label>کد تایید</label>
        <input type="text" id="otp_code">
        <button id="verify_otp_btn">تایید</button>
        <p class="error" id="otp_error"></p>
    </div>

    <!-- STEP 3: NAME -->
    <div class="step step-name">
        <label>نام شما</label>
        <input type="text" id="name">
        <button id="set_name_btn">ادامه</button>
        <p class="error" id="name_error"></p>
    </div>

    <!-- STEP 4: PASSWORD -->
    <div class="step step-password">
        <label>رمز عبور</label>
        <input type="password" id="password">
        <button id="set_password_btn">ثبت</button>
        <p class="error" id="password_error"></p>
    </div>

</div>
</div>

<script>

function csrf() {
    return document.cookie.split('; ').find(r => r.startsWith('csrftoken=')).split('=')[1];
}

function show(stepClass) {
    document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
    document.querySelector(stepClass).classList.add('active');
}

/* STEP 1 */
document.getElementById("send_otp_btn").onclick = async () => {
    const phone = document.getElementById("phone_number").value;

    const res = await fetch("{% url 'api_send_otp' %}", {
        method: "POST",
        headers: { "Content-Type": "application/json", "X-CSRFToken": csrf() },
        body: JSON.stringify({ phone_number: phone })
    });

    const data = await res.json();

    if (!data.success) return document.getElementById("phone_error").innerText = data.error;

    if (data.skip_otp) {
        show(".step-password");
    } else {
        show(".step-otp");
    }
};

/* STEP 2 */
document.getElementById("verify_otp_btn").onclick = async () => {
    const otp = document.getElementById("otp_code").value;

    const res = await fetch("{% url 'api_verify_otp' %}", {
        method: "POST",
        headers: { "Content-Type": "application/json", "X-CSRFToken": csrf() },
        body: JSON.stringify({ code: otp })
    });

    const data = await res.json();

    if (!data.success) return document.getElementById("otp_error").innerText = data.error;

    if (data.new_user) {
        show(".step-name");
    } else {
        window.location.href = "/dashboard/";
    }
};

/* STEP 3 */
document.getElementById("set_name_btn").onclick = async () => {
    const name = document.getElementById("name").value;

    const res = await fetch("{% url 'api_set_name' %}", {
        method: "POST",
        headers: { "Content-Type": "application/json", "X-CSRFToken": csrf() },
        body: JSON.stringify({ name })
    });

    const data = await res.json();

    if (!data.success) return document.getElementById("name_error").innerText = data.error;

    show(".step-password");
};

/* STEP 4 */
document.getElementById("set_password_btn").onclick = async () => {
    const password = document.getElementById("password").value;

    const res = await fetch("{% url 'api_set_password' %}", {
        method: "POST",
        headers: { "Content-Type": "application/json", "X-CSRFToken": csrf() },
        body: JSON.stringify({ password })
    });

    const data = await res.json();

    if (data.success) window.location.href = "/dashboard/";
    else document.getElementById("password_error").innerText = data.error;
};

</script>

</body>
</html>
